<!--
@license
Copyright (c) 2018 Pierre-Yves Gicquel. 
This code may only be used under the "Do whatever you want with code license"
-->
<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../../../bower_components/iron-label/iron-label.html">

<link rel="import" href="../../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../styles/common-styles.html">
<link rel=import href='./unitGame.html'>
<link rel="import" href="../remove-ressource/create-resource.html">
<link rel=import href='../helper/resource-picker-dialog.html'>
<dom-module id="mlg-constructor">

    <template>
            <style include="common-styles">
                </style>
            
        <resource-picker-dialog page id="pagePicker"></resource-picker-dialog>
        <resource-picker-dialog badge id="badgePicker"></resource-picker-dialog>
        <resource-picker-dialog page id="endPagePicker"></resource-picker-dialog>

        <create-resource id="creator" resource-url="/mlg" resource="{{resource}}"></create-resource>
        <form class="creator" id="mlgform" is="iron-form" method="post" action="/mlg">
            <template is="dom-if" if="{{updating}}" restamp>
                <paper-input hidden name="itemId" value="[[updateId]]"></paper-input>
            </template>

                <div class="card-content">
                    <paper-input style="width:300px;margin-bottom:10px;" name="label" value="{{mlgName}}" label="Label">
                        <iron-icon src="../../../images/labelFieldIcon.png" suffix></iron-icon>
                    </paper-input>
                    <paper-input name="duration" label="Durée" value="{{duration}}">
                        <div suffix style="color:#7f7f7f;">Minutes</div>
                    </paper-input>
                    <paper-textarea name="description" value={{description}} max-rows=0 rows=1 label="Description du jeu"></paper-textarea>

                    <iron-label style="color:#7f7f7f;">
                        Difficulté : [[difficulty]]
                        <paper-slider id="difficulty" name="difficulty" pin snaps max="10" step="1" style="width: 100%;" value="{{difficulty}}"></paper-slider>
                    </iron-label>
                    <paper-button class="blockButton" raised on-click="showMediaDialog">Ajouter une page de départ</paper-button>
                    <generic-resource-viewer is-temp is-picker input-name="startpage" label="Page de départ" page class="resourceViewer" id="startPage"></generic-resource-viewer>

                    <paper-button class="blockButton" raised on-click="showEndPagePicker">Ajouter une page de fin</paper-button>
                    <generic-resource-viewer is-temp is-picker input-name="endPage" page label="Page de fin" class="resourceViewer" id="endPage"></generic-resource-viewer>

                    <paper-button class="blockButton" raised on-click="showBadgeDialog">Ajouter un badge de récompense</paper-button>
                    <generic-resource-viewer is-temp no-header is-picker input-name="badge" label="Badge" badge class="resourceViewer" id="badgeViewer"></generic-resource-viewer>

                </div>
                <div class="card-actions">
                    <template is="dom-if" if="{{updating}}" restamp>
                        <paper-button raised on-click="submit">Update</paper-button>
                        <paper-button raised on-click="resetFields">Annuler update</paper-button>
                    </template>
                    <template is="dom-if" if="{{!updating}}" restamp>
                        <paper-button raised on-click="submit">Enregistrer</paper-button>
                        <paper-button raised on-click="resetFields">Annuler</paper-button>
                    </template>
                </div>
            <list-generic-subset-no-format items={{currentUnitGames}}></list-generic-subset-no-format>
        </form>


        <div style="display:inline-flex;width:97%;justify-content:space-between;">
            <list-generic-resource picker importer share-url='/unitgame' id='unitgameList' resource-type='unitgame' url='/unitgame'></list-generic-resource>

            <map-display class="mymap" id="gmap"></map-display>

        </div>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                is: 'mlg-constructor',
                ready: function () {
                    this.updating = false
                    this.difficulty = 3
                    this.duration = 5
                    this.$.unitgameList.addEventListener('itemPicked', this.addItem.bind(this))
                    this.$.pagePicker.addEventListener('resourcePicked', this.setResource.bind(this))
                    this.$.badgePicker.addEventListener('resourcePicked', this.setResource.bind(this))
                    this.$.unitgameList.addEventListener('change-poi-map', this.updateMap.bind(this))
                    this.$.endPagePicker.addEventListener('resourcePicked', this.setEndPage.bind(this))

                },
                edit: function (item) {
                    this.updating = true
                    this.updateId = item._id
                    this.mlgName = item.label
                    this.description = item.description
                    this.difficulty = item.difficulty
                    if (item.startpage) {
                        this.$.startPage.setPage(item.startpage)
                    }
                    if (item.unitGames && item.unitGames.length > 0) {
                        for (var i = 0; i < item.unitGames.length; i++) {
                            this.$.unitgameTopost.addItem(item.unitGames[i])
                        }
                    }
                    if (item.endPage) {
                        this.$.endPage.setPage(item.endPage)
                    }
                    if (item.badge) {
                        this.$.badgeViewer.setBadge(item.badge)
                    }

                },
                updateUnitGames: function () {
                    this.$.unitgameList.requestElements()
                },
                updateMap: function (event) {
                    var data = event.detail
                    if (data.show) {
                        this.$.gmap.showPOI(data.resource)
                    } else {
                        this.$.gmap.removePOI(data.resource)
                    }
                },
                setEndPage: function (message) {
                        this.$.endPage.setPage(message.detail.resourceItem)
                    }

                    ,
                setResource: function (message) {
                    switch (message.detail.resourceType) {
                        case "page":
                            this.$.startPage.setPage(message.detail.resourceItem)
                            break
                        case "badge":
                            this.$.badgeViewer.setBadge(message.detail.resourceItem)
                    }
                },

                addItem: function (event) {
                    if (event && event.detail && event.detail.item)
                        this.$.unitgameTopost.addItem(event.detail.item)
                },
                resetFields: function () {
                    this.$.endPage.removeResource()
                    this.$.badgeViewer.removeResource()
                    this.$.startPage.removeResource()
                    this.$.unitgameTopost.removeAllItems()
                    this.mlgName = ""
                    this.difficulty = 3
                    this.duration = 5
                    this.updating = false
                },
                showMediaDialog: function () {
                    this.$.pagePicker.open()
                },
                showEndPagePicker: function () {
                    this.$.endPagePicker.open()
                },

                showBadgeDialog: function () {
                    this.$.badgePicker.open()
                },

                getUnitActivityAsJSON: function () {
                    if (this.items) {
                        var exp = JSON.stringify(this.items);
                        return exp;
                    }
                    return {}
                },

                submit: function () {
                    var json = this.$.mlgform.serialize()
                    this.set('resource', json)
                    this.$.creator.createResource()
                    this.resetFields()
                },

                properties: {
                    item: {
                        type: Object,
                        notify: true,
                    },
                },
            });
        })();
    </script>
</dom-module>